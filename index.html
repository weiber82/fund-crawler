<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è³‡ç”¢é…ç½® & æœªä¾†é æ¸¬ (åš´æ ¼å›æ¸¬ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100 text-slate-800 font-sans p-4">

<div class="max-w-6xl mx-auto space-y-6">
    
    <div class="bg-gradient-to-r from-red-700 to-red-900 p-6 rounded-xl text-white shadow-lg flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold"><i class="fa-solid fa-chart-line mr-2"></i> æ™ºèƒ½è³‡ç”¢é…ç½® & æœªä¾†é æ¸¬</h1>
            <p class="text-red-100 text-sm mt-1">Portfolio Backtest & Future Projection (TW Mode)</p>
        </div>
        <div class="text-right">
            <div class="text-xs opacity-70">è³‡æ–™ä¾†æº</div>
            <div class="font-bold">Supabase Database</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            
            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-700">ğŸ›’ å»ºç«‹æŠ•è³‡çµ„åˆ</h3>
                    <button onclick="addFundRow()" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 transition">
                        <i class="fa-solid fa-plus"></i> æ–°å¢æ¨™çš„
                    </button>
                </div>
                
                <div id="portfolio-list" class="space-y-3 mb-4"></div>

                <div class="flex justify-between text-sm font-bold text-slate-600 border-t pt-3">
                    <span>ç¸½é…ç½®æ¯”ä¾‹:</span>
                    <span id="total-weight" class="text-green-600">0%</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                <h3 class="font-bold text-lg text-slate-700 mb-4">âš™ï¸ è¨­å®šåƒæ•¸</h3>
                
                <div class="space-y-4">
                    
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="setMode('dca')" id="btn-dca" class="flex-1 py-2 text-sm font-bold rounded-md shadow-sm transition bg-white text-red-600">
                            å®šæœŸå®šé¡
                        </button>
                        <button onclick="setMode('lump')" id="btn-lump" class="flex-1 py-2 text-sm font-bold rounded-md transition text-slate-500 hover:text-slate-700">
                            å–®ç­†ç”³è³¼ (èº‰ç¹³)
                        </button>
                    </div>

                    <div class="bg-yellow-50 p-2 rounded border border-yellow-200">
                        <label class="block text-xs font-bold text-yellow-800 mb-1">ğŸ“… è¨­å®šé€²å ´æ—¥æœŸ (å›æ¸¬èµ·é»)</label>
                        <input type="date" id="start-date" value="2020-01-01" class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-red-500 outline-none transition cursor-pointer font-bold text-slate-700">
                        <p class="text-[10px] text-yellow-600 mt-1">* ç³»çµ±å°‡å‡è¨­æ‚¨åœ¨æ­¤æ—¥é€²å ´æŠ•è³‡</p>
                    </div>

                    <div id="dca-inputs" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">æ¯æœˆæ‰£æ¬¾é‡‘é¡ (TWD)</label>
                            <input type="number" id="monthly-amount" value="10000" step="1000" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">æ¯æœˆæ‰£æ¬¾æ—¥ (1-28è™Ÿ)</label>
                            <input type="number" id="invest-day" value="6" min="1" max="28" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none transition">
                        </div>
                    </div>

                    <div id="lump-inputs" class="hidden space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">å–®ç­†æŠ•å…¥é‡‘é¡ (TWD)</label>
                            <input type="number" id="lump-sum-amount" value="1000000" step="10000" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none transition">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">åŒ¯ç‡è¨­å®š (USD to TWD)</label>
                        <input type="number" id="usd-rate" value="32.5" step="0.1" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-red-500 outline-none transition">
                        <p class="text-[10px] text-gray-400 mt-1">* åƒ…é‡å°ç¾å…ƒè¨ˆåƒ¹åŸºé‡‘é€²è¡Œæ›ç®—</p>
                    </div>
                </div>

                <button onclick="runCalculation()" class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition transform active:scale-95">
                    ğŸš€ é–‹å§‹è©¦ç®—
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-gray-400">
                    <div class="text-xs text-gray-500">ç¸½æŠ•å…¥æœ¬é‡‘</div>
                    <div id="stat-cost" class="text-xl font-bold text-gray-800">$0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500">
                    <div class="text-xs text-gray-500">ç›®å‰å¸³æˆ¶åƒ¹å€¼</div>
                    <div id="stat-value" class="text-xl font-bold text-red-600">$0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
                    <div class="text-xs text-gray-500">ç¸½æç›Š</div>
                    <div id="stat-profit" class="text-xl font-bold text-yellow-600">$0</div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
                    <div class="text-xs text-gray-500">æ­·å²å¹´åŒ–å ±é…¬ (CAGR)</div>
                    <div id="stat-cagr" class="text-xl font-bold text-purple-600">0%</div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-200 relative">
                <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-10 hidden flex flex-col items-center justify-center text-red-600">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3"></i>
                    <span class="font-bold">AI é‹ç®—ä¸­...</span>
                </div>
                <div id="chart-container" class="w-full h-[500px]"></div>
            </div>

            <div class="bg-slate-50 p-4 rounded-lg text-sm text-slate-700 border border-slate-200">
                <h4 class="font-bold mb-1"><i class="fa-solid fa-crystal-ball"></i> æœªä¾†æ¨¡æ“¬èªªæ˜</h4>
                <p>è™›ç·šéƒ¨åˆ†ç‚ºåŸºæ–¼è©²æŠ•è³‡çµ„åˆã€Œæ­·å²å¹´åŒ–å ±é…¬ç‡ã€èˆ‡ã€Œæ­·å²æ³¢å‹•ç‡ã€æ‰€æ¨ç®—çš„æœªä¾† 5 å¹´èµ°å‹¢ã€‚ <br>
                <span class="text-red-600 font-bold">â— æ¨‚è§€ (High)</span>: å‡è¨­å¹´åŒ–å ±é…¬ + 1å€æ¨™æº–å·® (ç´…æ¼²)<br>
                <span class="text-blue-600 font-bold">â— å¹³å‡ (Avg)</span>: å‡è¨­ç¶­æŒæ­·å²å¹³å‡å¹´åŒ–å ±é…¬ <br>
                <span class="text-green-600 font-bold">â— æ‚²è§€ (Low)</span>: å‡è¨­å¹´åŒ–å ±é…¬ - 1å€æ¨™æº–å·® (ç¶ è·Œ)
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸ”‘ è«‹å¡«å…¥ä½ çš„ Supabase è³‡è¨Š
    // ==========================================
    const SUPABASE_URL = 'https://eytumbuyxpdvcoychphj.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_Xt1hKEf5Ye5p-vhFJvvOEg_JP4c2dGQ';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let myChart = null;
    let allFundsList = []; 
    let currentMode = 'dca'; 

    document.addEventListener('DOMContentLoaded', async () => {
        await loadFundList();
        addFundRow();
    });

    window.setMode = function(mode) {
        currentMode = mode;
        const btnDca = document.getElementById('btn-dca');
        const btnLump = document.getElementById('btn-lump');
        const inputDca = document.getElementById('dca-inputs');
        const inputLump = document.getElementById('lump-inputs');

        if (mode === 'dca') {
            btnDca.className = "flex-1 py-2 text-sm font-bold rounded-md shadow-sm transition bg-white text-red-600";
            btnLump.className = "flex-1 py-2 text-sm font-bold rounded-md transition text-slate-500 hover:text-slate-700";
            inputDca.classList.remove('hidden');
            inputLump.classList.add('hidden');
        } else {
            btnLump.className = "flex-1 py-2 text-sm font-bold rounded-md shadow-sm transition bg-white text-red-600";
            btnDca.className = "flex-1 py-2 text-sm font-bold rounded-md transition text-slate-500 hover:text-slate-700";
            inputLump.classList.remove('hidden');
            inputDca.classList.add('hidden');
        }
    }

    async function loadFundList() {
        try {
            const { data, error } = await supabase.from('funds').select('id, name, currency').order('id');
            if (error) throw error;
            allFundsList = data;
        } catch (err) {
            console.error('è¼‰å…¥æ¸…å–®å¤±æ•—', err);
            alert('ç„¡æ³•é€£ç·šè³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ Key');
        }
    }

    window.addFundRow = function() {
        const container = document.getElementById('portfolio-list');
        const div = document.createElement('div');
        div.className = "flex items-center gap-2 fund-row mb-2"; 
        
        let optionsHtml = '<option value="" disabled selected>é¸æ“‡æ¨™çš„</option>';
        allFundsList.forEach(f => {
            let shortName = f.name.split('(')[0].trim();
            if (shortName.length > 12) shortName = shortName.substring(0, 12) + '...';
            optionsHtml += `<option value="${f.id}" data-curr="${f.currency}">[${f.currency}] ${shortName}</option>`;
        });

        div.innerHTML = `
            <select class="fund-select flex-1 min-w-0 p-2 border rounded text-sm outline-none focus:border-red-500 truncate">
                ${optionsHtml}
            </select>
            <div class="relative w-20 flex-shrink-0">
                <input type="number" class="fund-weight w-full p-2 border rounded text-sm text-center outline-none focus:border-red-500" placeholder="%" value="100">
                <span class="absolute right-6 top-2 text-gray-400 text-xs pointer-events-none">%</span>
            </div>
            <button onclick="this.parentElement.remove(); checkWeight();" class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition">
                <i class="fa-solid fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
        div.querySelector('.fund-weight').addEventListener('input', checkWeight);
        checkWeight();
    }

    function checkWeight() {
        const inputs = document.querySelectorAll('.fund-weight');
        let total = 0;
        inputs.forEach(input => total += parseFloat(input.value) || 0);
        const display = document.getElementById('total-weight');
        display.innerText = total + "%";
        display.className = total === 100 ? "text-blue-600 font-bold" : "text-red-500 font-bold";
    }

    // 4. æ ¸å¿ƒé‹ç®— (æ—¥æœŸåš´æ ¼éæ¿¾ç‰ˆ + Forward Fill)
    window.runCalculation = async function() {
        const rows = document.querySelectorAll('.fund-row');
        const portfolio = [];
        let totalWeight = 0;

        rows.forEach(row => {
            const select = row.querySelector('.fund-select');
            const weightInput = row.querySelector('.fund-weight');
            const fundId = select.value;
            const currency = select.options[select.selectedIndex]?.getAttribute('data-curr');
            const weight = parseFloat(weightInput.value) || 0;

            if (fundId && weight > 0) {
                portfolio.push({ id: fundId, weight: weight / 100, currency: currency });
                totalWeight += weight;
            }
        });

        if (portfolio.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€æª”åŸºé‡‘");
        if (Math.abs(totalWeight - 100) > 0.1) return alert("æ¬Šé‡ç¸½å’Œå¿…é ˆç‚º 100%");

        const monthlyAmt = parseFloat(document.getElementById('monthly-amount').value);
        const lumpSumAmt = parseFloat(document.getElementById('lump-sum-amount').value);
        const investDay = parseInt(document.getElementById('invest-day').value);
        const usdRate = parseFloat(document.getElementById('usd-rate').value);
        
        // å–å¾—ä½¿ç”¨è€…è¨­å®šçš„ã€Œé€²å ´æ—¥æœŸã€
        const userStartDateStr = document.getElementById('start-date').value;
        const userStartDate = userStartDateStr ? new Date(userStartDateStr) : new Date('1990-01-01');

        document.getElementById('loading-overlay').classList.remove('hidden');

        try {
            const promises = portfolio.map(item => 
                supabase.from('fund_navs').select('nav_date, nav_value')
                .eq('fund_id', item.id).order('nav_date', { ascending: true }).limit(50000)
            );

            const results = await Promise.all(promises);
            const fundDataMap = {}; 

            results.forEach((res, index) => {
                if(res.error) throw res.error;
                const data = res.data;
                if(data.length === 0) throw new Error(`åŸºé‡‘ ${portfolio[index].id} ç„¡è³‡æ–™`);
                fundDataMap[portfolio[index].id] = data;
            });

            // --- æ­¥é©Ÿ A: å»ºç«‹çµ±ä¸€æ™‚é–“è»¸ ---
            // è¦å‰‡ï¼šåªåŒ…å« >= ä½¿ç”¨è€…è¨­å®šæ—¥æœŸ çš„äº¤æ˜“æ—¥
            let dateSet = new Set();
            portfolio.forEach(p => {
                fundDataMap[p.id].forEach(d => {
                    if (new Date(d.nav_date) >= userStartDate) {
                        dateSet.add(d.nav_date);
                    }
                });
            });
            const timeline = Array.from(dateSet).sort();

            if(timeline.length === 0) throw new Error("é¸å®šçš„æ—¥æœŸå€é–“æ²’æœ‰è³‡æ–™ï¼Œè«‹å°‡æ—¥æœŸå¾€å‰èª¿æ•´ (è«‹é¸éå»çš„æ—¥æœŸ)");

            // å›æ¸¬è®Šæ•¸
            let totalUnits = portfolio.map(() => 0); 
            let totalCost = 0;
            const chartDates = [];
            const chartCost = [];
            const chartValue = [];
            
            let lastKnownNavs = portfolio.map(() => null);
            let lastInvestMonth = "";

            // --- æ­¥é©Ÿ B: é–‹å§‹è·‘æ¯ä¸€å¤© ---
            timeline.forEach((dateStr, tIndex) => {
                const currentDate = new Date(dateStr);
                
                // 1. æ›´æ–°å ±åƒ¹ (Forward Fill)
                portfolio.forEach((p, idx) => {
                    const fundNavs = fundDataMap[p.id];
                    const navRecord = fundNavs.find(n => n.nav_date === dateStr);
                    if (navRecord) {
                        lastKnownNavs[idx] = navRecord.nav_value;
                    }
                });

                const allFundsReady = lastKnownNavs.every(v => v !== null);

                if (allFundsReady) {
                    
                    // 2. äº¤æ˜“é‚è¼¯
                    
                    // [å–®ç­†ç”³è³¼]ï¼šåœ¨æ™‚é–“è»¸çš„ã€Œç¬¬ä¸€å¤©ã€ç›´æ¥è²·å…¥
                    // é€™æ¨£æ‰ç¬¦åˆã€Œå‡è¨­æˆ‘åœ¨é€™å¤©é€²å ´ã€çš„é‚è¼¯
                    if (currentMode === 'lump' && totalCost === 0) {
                        totalCost = lumpSumAmt;
                        portfolio.forEach((p, idx) => {
                            let exchangeRate = (p.currency === 'USD') ? usdRate : 1;
                            const moneyForFund = lumpSumAmt * p.weight;
                            totalUnits[idx] = (moneyForFund / exchangeRate) / lastKnownNavs[idx];
                        });
                    }

                    // [å®šæœŸå®šé¡]ï¼šä¾ç…§æ—¥æœŸæ‰£æ¬¾
                    if (currentMode === 'dca') {
                        const day = currentDate.getDate();
                        const monthStr = dateStr.substring(0, 7);
                        let isInvestDay = (day >= investDay && lastInvestMonth !== monthStr);
                        
                        if (isInvestDay) {
                            totalCost += monthlyAmt;
                            lastInvestMonth = monthStr;
                            
                            portfolio.forEach((p, idx) => {
                                let nav = lastKnownNavs[idx]; 
                                let exchangeRate = (p.currency === 'USD') ? usdRate : 1;
                                const moneyForFund = monthlyAmt * p.weight;
                                const unitsBought = (moneyForFund / exchangeRate) / nav;
                                totalUnits[idx] += unitsBought;
                            });
                        }
                    }

                    // 3. è¨ˆç®—å¸‚å€¼
                    let currentPortfolioValue = 0;
                    portfolio.forEach((p, idx) => {
                        let nav = lastKnownNavs[idx];
                        let exchangeRate = (p.currency === 'USD') ? usdRate : 1;
                        currentPortfolioValue += totalUnits[idx] * nav * exchangeRate;
                    });

                    chartDates.push(dateStr);
                    chartCost.push(totalCost);
                    chartValue.push(currentPortfolioValue);
                }
            });

            // --- æ­¥é©Ÿ C: æœªä¾†é æ¸¬ (åŸºæ–¼å›æ¸¬å€é–“çš„ CAGR) ---
            let weightedCAGR = 0;
            
            // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ã€ŒæŠ•è³‡çµ„åˆçš„ç¸½å ±é…¬ã€ä¾†ç®— CAGRï¼Œé€™æ¨£æœ€æº–ç¢º
            // å…¬å¼: (æœŸæœ«ç¸½å€¼ / ç¸½æŠ•å…¥æˆæœ¬) ^ (1 / å¹´æ•¸) - 1 
            // æ³¨æ„ï¼šé€™å°å–®ç­†ç”³è³¼å¾ˆæº–ã€‚å° DCA ä¾†èªªé€™æ˜¯å›å ±ç‡ï¼Œä¸å®Œå…¨æ˜¯ CAGRï¼Œä½†ç”¨ä¾†åšè¶¨å‹¢é æ¸¬æ˜¯å¯ä»¥çš„
            
            const finalValue = chartValue[chartValue.length - 1];
            const startValue = (currentMode === 'lump') ? totalCost : chartValue[0]; // DCA ä¸€é–‹å§‹å¸‚å€¼å¾ˆä½
            
            // ç‚ºäº†é æ¸¬åˆç†ï¼Œæˆ‘å€‘è¨ˆç®—æ¯ä¸€æª”åŸºé‡‘åœ¨ã€Œé€™æ®µæœŸé–“ã€çš„å€‹åˆ¥è¡¨ç¾ä¾†åŠ æ¬Š
            portfolio.forEach((p, idx) => {
                const fundNavs = fundDataMap[p.id];
                // æ‰¾å‡ºå€é–“å…§çš„é ­å°¾
                // æ³¨æ„ï¼šè¦æ‰¾ >= timeline[0] çš„
                const startNavObj = fundNavs.find(n => n.nav_date >= timeline[0]);
                const endNavObj = fundNavs.find(n => n.nav_date === timeline[timeline.length-1]) || fundNavs[fundNavs.length-1];
                
                if (startNavObj && endNavObj) {
                    const sPrice = startNavObj.nav_value;
                    const ePrice = endNavObj.nav_value;
                    const days = (new Date(endNavObj.nav_date) - new Date(startNavObj.nav_date)) / (1000*60*60*24);
                    const years = days / 365.25;
                    
                    if (years > 0.5) {
                        const fundCagr = Math.pow(ePrice / sPrice, 1/years) - 1;
                        weightedCAGR += fundCagr * p.weight;
                    }
                }
            });

            // å¦‚æœå›æ¸¬æ™‚é–“å¤ªçŸ­ï¼ŒCAGR å¯èƒ½æœƒå¤±çœŸï¼Œçµ¦å€‹é è¨­å€¼
            if (chartDates.length < 100 && weightedCAGR === 0) weightedCAGR = 0.06;

            let volatility = 0.15; 
            if (weightedCAGR > 0.25) volatility = 0.25; 
            if (weightedCAGR < 0.05) volatility = 0.08;

            document.getElementById('stat-cost').innerText = '$' + Math.round(totalCost).toLocaleString();
            document.getElementById('stat-value').innerText = '$' + Math.round(chartValue[chartValue.length-1]).toLocaleString();
            const profitVal = chartValue[chartValue.length-1] - totalCost;
            document.getElementById('stat-profit').innerText = '$' + Math.round(profitVal).toLocaleString();
            document.getElementById('stat-profit').className = `text-xl font-bold ${profitVal >= 0 ? 'text-red-600' : 'text-green-600'}`;
            document.getElementById('stat-cagr').innerText = (weightedCAGR * 100).toFixed(2) + '%';

            const futureDates = [];
            const futureHigh = [];
            const futureAvg = [];
            const futureLow = [];
            
            let lastVal = chartValue[chartValue.length-1];
            let lastDate = new Date(chartDates[chartDates.length-1]);
            const dailyGrowthAvg = Math.pow(1 + weightedCAGR, 1/250) - 1;

            let projectionGrowth = dailyGrowthAvg;
            if (weightedCAGR > 0.30) {
                projectionGrowth = Math.pow(1 + 0.30, 1/250) - 1; 
            }

            for(let i=0; i<1250; i++) { 
                lastDate.setDate(lastDate.getDate() + 1);
                if(lastDate.getDay() === 0 || lastDate.getDay() === 6) continue;
                
                const dateStr = lastDate.toISOString().split('T')[0];
                futureDates.push(dateStr);
                const n = i + 1;

                const valAvg = lastVal * Math.pow(1 + projectionGrowth, n);
                const valHigh = valAvg * Math.exp(volatility * Math.sqrt(n/250));
                const valLow = valAvg * Math.exp(-volatility * Math.sqrt(n/250));

                futureAvg.push(Math.round(valAvg));
                futureHigh.push(Math.round(valHigh));
                futureLow.push(Math.round(valLow));
            }

            drawChart(chartDates, chartCost, chartValue, futureDates, futureHigh, futureAvg, futureLow);

        } catch (err) {
            console.error(err);
            alert('éŒ¯èª¤: ' + err.message);
        } finally {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    }

    function drawChart(dates, cost, value, fDates, fHigh, fAvg, fLow) {
        const dom = document.getElementById('chart-container');
        if (myChart) myChart.dispose(); 
        myChart = echarts.init(dom);

        const lastValue = value[value.length-1];
        
        const option = {
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { top: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: [...dates, ...fDates]
            },
            yAxis: {
                type: 'value',
                axisLabel: { formatter: (val) => (val/10000).toFixed(0) + 'è¬' }
            },
            dataZoom: [{ type: 'inside' }, { type: 'slider', bottom: 0 }],
            series: [
                {
                    name: 'ç´¯ç©æœ¬é‡‘', type: 'line',
                    data: [...cost, ...Array(fDates.length).fill(null)],
                    itemStyle: { color: '#94a3b8' }, areaStyle: { color: '#f1f5f9', opacity: 0.5 },
                    showSymbol: false, step: 'end'
                },
                {
                    name: 'å¸³æˆ¶åƒ¹å€¼ (æ­·å²)', type: 'line',
                    data: [...value.map(v => v == null ? null : Math.round(v)), ...Array(fDates.length).fill(null)],
                    itemStyle: { color: '#2563eb' }, showSymbol: false, lineStyle: { width: 3 }
                },
                {
                    name: 'é æ¸¬ (æ¨‚è§€)', type: 'line',
                    data: [...Array(dates.length-1).fill(null), lastValue, ...fHigh],
                    lineStyle: { type: 'dashed', width: 2, color: '#dc2626' }, showSymbol: false
                },
                {
                    name: 'é æ¸¬ (å¹³å‡)', type: 'line',
                    data: [...Array(dates.length-1).fill(null), lastValue, ...fAvg],
                    lineStyle: { type: 'dashed', width: 2, color: '#3b82f6' }, showSymbol: false
                },
                {
                    name: 'é æ¸¬ (æ‚²è§€)', type: 'line',
                    data: [...Array(dates.length-1).fill(null), lastValue, ...fLow],
                    lineStyle: { type: 'dashed', width: 2, color: '#16a34a' }, showSymbol: false
                }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }
</script>

</body>
</html>